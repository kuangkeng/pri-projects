<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
    <style>

      body {
        font: 1.1em sans-serif;
      }

      #chart{
        max-width: 320px;
        width: 100%;
        margin: 0 auto;
      }
      .background {
        fill: #eee;
      }

      line {
        stroke: #fff;
      }

      text.active {
        fill: red;
      }

      .day {
        fill: #fff;
        stroke: #ccc;
      }

      .month {
        fill: none;
        stroke: #fff;
        stroke-width: 4px;
      }
      .year-title {
        font-size: 16px;
      }
      .month-title {
        font-size: 12px;
      }

      /* color ranges */
      .bucket0 { fill: #FDC859; }
      .bucket1 { fill: #F7AD51; }
      .bucket2 { fill: #F09249; }
      .bucket3 { fill: #EA7841; }
      .bucket4 { fill: #E35D38; }
      .bucket4 { fill: #DD4230; }
      .bucket4 { fill: #D62728; }

      /* hover info */
      #tooltip {
        background-color: #fff;
        border: 2px solid #ccc;
        padding: 10px;
      }

    </style>
  </head>
    <body>

      <div id="chart"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script>
    var ww = $("#chart").width(),
        width = ww-20,
        height = width*1.5,
        cellSize = width/23.8; // cell size

    var color = d3.scale.linear()
        .domain([13, 124])
        .range(d3.range(7).map(function(i) { return "bucket" + i; }));

    var no_months_in_a_row = 3;
    var shift_up = cellSize * 3;

    var day = d3.time.format("%w"), // day of the week
        day_of_month = d3.time.format("%e") // day of the month
        day_of_year = d3.time.format("%j")
        week = d3.time.format("%U"), // week number of the year
        month = d3.time.format("%m"), // month number
        year = d3.time.format("%Y"),
        percent = d3.format(".1%"),
        format = d3.time.format("%Y-%m-%d"),
        parseDate = d3.time.format('%Y-%m-%d').parse;

    var svg = d3.select("#chart").selectAll("svg")
        .data(d3.range(2016, 2017))
      .enter().append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("class", "RdYlGn")
      .append("g")

    var rect = svg.selectAll(".day")
        .data(function(d) { 
          return d3.time.days(new Date(d, 0, 1), new Date(d + 1, 0, 1));
        })
      .enter().append("rect")
        .attr("class", "day")
        .attr("width", cellSize)
        .attr("height", cellSize)
        .attr("x", function(d) {
          var month_padding = 1.2 * cellSize*7 * ((month(d)-1) % (no_months_in_a_row));
          return day(d) * cellSize + month_padding; 
        })
        .attr("y", function(d) { 
          var week_diff = week(d) - week(new Date(year(d), month(d)-1, 1) );
          var row_level = Math.ceil(month(d) / (no_months_in_a_row));
          return (week_diff*cellSize) + row_level*cellSize*8 - cellSize/2 - shift_up;
        })
        .datum(format);

    var month_titles = svg.selectAll(".month-title")  // Jan, Feb, Mar and the whatnot
          .data(function(d) { 
            return d3.time.months(new Date(d, 0, 1), new Date(d + 1, 0, 1)); })
        .enter().append("text")
          .text(monthTitle)
          .attr("x", function(d, i) {
            var month_padding = 1.2 * cellSize*7* ((month(d)-1) % (no_months_in_a_row));
            return month_padding;
          })
          .attr("y", function(d, i) {
            var week_diff = week(d) - week(new Date(year(d), month(d)-1, 1) );
            var row_level = Math.ceil(month(d) / (no_months_in_a_row));
            return (week_diff*cellSize) + row_level*cellSize*8 - cellSize - shift_up;
          })
          .attr("class", "month-title")
          .attr("d", monthTitle);

    var year_titles = svg.selectAll(".year-title")  // Jan, Feb, Mar and the whatnot
          .data(function(d) { 
            return d3.time.years(new Date(d, 0, 1), new Date(d + 1, 0, 1)); })
        .enter().append("text")
          .text(yearTitle)
          .attr("x", function(d, i) { return width/2 - width*0.05; })
          .attr("y", function(d, i) { return cellSize*5 - shift_up; })
          .attr("class", "year-title")
          .attr("d", yearTitle);


    //  Tooltip Object
    var tooltip = d3.select("body")
      .append("div").attr("id", "tooltip")
      .style("position", "absolute")
      .style("z-index", "10")
      .style("visibility", "hidden")
      .text("a simple tooltip");

    d3.json('data-sample/incidents-deaths-2016.json', function(error, data) {
        
        if (error) return console.warn(error);
      
        var data = d3.nest()
            .key(function (d) { return parseDate(d.date.split(' ')[0]); })
            .rollup(function (n) { 
                return d3.sum(n, function (d) { 
                    return d.incidents; // key
                }); 
            })
            .map(data);

      // var data = d3.nest()
      //   .key(function(d) { return d.Date; })
      //   .rollup(function(d) { return (d[0].Close - d[0].Open) / d[0].Open; })
      //   .map(csv);

      rect.filter(function(d) { return d in data; })
          .attr("class", function(d) { return color(data[d]); })
          .select("title")
          .text(function(d) { return d + ": " + data[d]; });

      //  Tooltip
      // rect.on("mouseover", mouseover);
      // rect.on("mouseout", mouseout);
      // function mouseover(d) {
      //   tooltip.style("visibility", "visible");
      //   var percent_data = (data[d] !== undefined) ? percent(data[d]) : percent(0);
      //   var purchase_text = d + ": " + percent_data;

      //   tooltip.transition()        
      //               .duration(200)      
      //               .style("opacity", .9);      
      //   tooltip.html(purchase_text)  
      //               .style("left", (d3.event.pageX)+30 + "px")     
      //               .style("top", (d3.event.pageY) + "px"); 
      // }
      // function mouseout (d) {
      //   tooltip.transition()        
      //           .duration(500)      
      //           .style("opacity", 0); 
      //   var $tooltip = $("#tooltip");
      //   $tooltip.empty();
      // }

    });

    function dayTitle (t0) {
      return t0.toString().split(" ")[2];
    }
    function monthTitle (t0) {
      return t0.toLocaleString("en-us", { month: "short" }).toUpperCase();
    }
    function yearTitle (t0) {
      return t0.toString().split(" ")[3];
    }
  </script>

  </body>
</html>