
<!DOCTYPE html>
<html>
<head>
<title>Where's Addis Ababa?</title>
<meta name="description" content="President Obama is going to visit Addis Ababa, but do you know where it is?"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta property="og:type" content="website" /> 
<meta property="og:site_name" content="PRI Map Quiz" />
<meta property="og:description" content="President Obama is going to visit Addis Ababa, but do you know where it is?" />
<meta property="og:title" content="Where's Addis Ababa?" />
<meta property="og:url" content="http://kuangkeng.github.io/pri-projects/map-quiz.html"/>
<meta property="og:image" content="http://kuangkeng.github.io/pri-projects/RTR2X79V.jpg"/>
<meta property="fb:app_id" content="874944082601390"/>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.4.2/tabletop.min.js"></script> 

<style type="text/css">


*, *:before, *:after {
  -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box;
 }

html {  -webkit-text-size-adjust: none; height: 100%; width: 100%; overflow: hidden; }
body {
  font-family: "Source Sans Pro","Helvetica Neue",Helvetica,Arial,"Nimbus Sans L",sans-serif;
}
h1 { text-align: center; font-size: 30px; font-size: 6vh; line-height: 30px; line-height: 6vh; font-weight: bold; color: #D3401E; }
#map-canvas { position: absolute; top: 0; left: 0; height: 100%; width: 100%; z-index: 0; }
#iframe-shim { position: absolute; top: 0; left: 0; height: 100%; width: 100%; z-index: 1; pointer-events: none; }

.panel { position: absolute; bottom: 0px; left: 0; width: 100%; text-align: center; display: none; padding: 20px; font-size: 18px; font-size: 3vh; line-height: 23px; line-height: 3vh; color: #fff; background-color: rgba(0,0,0,0.8);}
.panel button { width: 90%; padding: 10px 20px; font-size: 20px; font-size: 3vh; line-height: 20px; line-height: 3vh; margin-top: 0.5em; }
.panel input { width: 3em; padding: 5px 0px; font-size: 20px; font-size: 3vh; margin-top: 0.5em; text-align: right; border: none; background: transparent; outline: none; border-bottom: 1px dotted #eee; color: #fff; }
.panel input:invalid { outline: none; }
#guess { width: 4em; }
.panel p { padding-bottom: 0.2em; }

p.data { font-size: 12px !important; margin-top: 10px; }

@media screen and (min-aspect-ratio: 1/1) {

  #endgame button { width: 30%; }

}

.wait { cursor: wait; }

</style>

<script src="https://maps.googleapis.com/maps/api/js?v=3.12&libraries=geometry,visualization&sensor=false"></script>
<script>

var sv;
var map;
var heatmap;
var state = 0;

var homeCircle = {
  path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
  scale: 3,
  strokeColor: "#ff7f00",
  strokeWeight: 3
};


var guessCircle = {
  path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
  scale: 3,
  strokeColor: "#fa1414",
  strokeWeight: 3
};



var addisCircle = {
  path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
  scale: 3,
  strokeColor: "green",
  strokeWeight: 3
};



var homeMarker = new google.maps.Marker({icon: homeCircle});
var guessMarker = new google.maps.Marker({icon: guessCircle});
var addisMarker = new google.maps.Marker({position: new google.maps.LatLng(9.03, 38.74), icon: addisCircle});

var tweet_rating = [
"I couldn't find a piss up in a brewery.",
"I'm not on the road to addis. I can't even find it.",
"I can't find addis on a map. Help me!",
"I'm pretty poor at addis finding!",
"I'm nearly on the road to addis!",
"I'm almost on the road to addis!",
"I'm on the road to addis!",
"I'm definitely on the road to addis!",
"Ask me where addis is. I know.",
"I'm a Grade-A addis finder!",
"I'm a Grade-A addis finder!"
];

var rating = [
"You couldn't find a piss up in a brewery!",
"You're not on the road to addis. You can't even find it!",
"You can't find addis!",
"You're pretty poor at addis finding!",
"You're nearly on the road to addis!",
"You're almost on the road to addis!",
"You're on the road to addis!",
"You're definitely on the road to addis!",
"People should ask you for directions!",
"You're a Grade-A addis finder!",
"You're a Grade-A addis finder!"
];


var startPosition = new google.maps.LatLng(20,0);
var startZoom = 2;
var country_code;

var mapOptions = {
  zoom: startZoom,
  minZoom: 1,
  maxZoom: 8,
  center: startPosition,
  disableDefaultUI: true,
  zoomControl: true,
  mapTypeId: google.maps.MapTypeId.SATELLITE
};

var geocoder = new google.maps.Geocoder();

var guesses = [];
var dataset = [];

var meters;

var score;
var miles;

function panel(id) {

  $('.panel').slideUp(500);
  $('#' + id).slideDown(500);
  if(id != 'options') {
    $('#' + id + ' button:eq(0)').focus();
  }
 
}

function codeLatLng(latlng) {
  country_code = 'xx';
  geocoder.geocode({'latLng': latlng}, function(results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      if (results[0]) {
        try {
          var x;
          for (var i=0;i<results[0].address_components.length;i++) {
            x = results[0].address_components[i].types;
            if (x.indexOf('country') != -1) {
              country_code = results[0].address_components[i].short_name;
            }
          }
        } catch(err) {
          country_code = 'xx';
        }
      }
    } else {
      country_code = 'xx';
    }
  });
}


function handleClick(latLng) {

  switch(state) {
  
    case 1:
      homeMarker.setPosition(latLng);
      homeMarker.setMap(map);
      codeLatLng(latLng);
      $('#home_placed').attr('disabled',false);
      break;
    case 2:
      guessMarker.setPosition(latLng);
      guessMarker.setMap(map);
      $('#guess_placed').attr('disabled',false);
      break;

  
  }

}

function init() {
  
  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  var worldBounds = new google.maps.LatLngBounds(new google.maps.LatLng(-65,-20),
                                                 new google.maps.LatLng(65,20));
  map.fitBounds(worldBounds);
  panel('instructions');
  
  $('#start').click(function () {
  
    panel('you');
    state = 1;
  
  });
  
  $('#home_placed').click(function () {
  
    panel('addis');
    var worldBounds = new google.maps.LatLngBounds(new google.maps.LatLng(-65,-180),
                                                 new google.maps.LatLng(65,180));
    map.fitBounds(worldBounds);
    state = 2;
  
  });
  
  $('#guess_placed').click(function () {
    
    $.ajax({
      type: 'POST',
      url: 'https://docs.google.com/forms/d/1y_TFP1KxxiQNbo_jHi18FvJQHhSIFg-YBh7WEwfmGQ0/formResponse',
      data: 
      { 
        "entry.163459536": guessMarker.position.lat(),
        "entry.903441567": guessMarker.position.lng(),
        "entry.469720109": homeMarker.position.lat(),
        "entry.882057108": homeMarker.position.lng(),
        "entry.577618485": country_code,
        "entry.592194316": document.referrer,
       }
    });
    
    var bounds = new google.maps.LatLngBounds();
    addisMarker.setMap(map);
    bounds.extend(guessMarker.position);
    bounds.extend(addisMarker.position);
    map.fitBounds(bounds);
    
    map.setZoom(map.getZoom()-1);
    meters = google.maps.geometry.spherical.computeDistanceBetween (guessMarker.position, addisMarker.position);
    miles = meters / 1609.344
    $('#miles_score').text(Math.round(miles));
    
    map.setMapTypeId(google.maps.MapTypeId.TERRAIN);
    
    var guessLine = new google.maps.Polyline({
      path: [guessMarker.position, addisMarker.position],
      strokeColor: "#fa1414",
      strokeOpacity: 1.0,
      strokeWeight: 3,
      map: map
    });

    state = 3;
    
    panel('results');
  
  });
  
  $('#compare').click(function () {
  
    map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
    var worldBounds = new google.maps.LatLngBounds(new google.maps.LatLng(-65,-20),
                                                 new google.maps.LatLng(65,20));
    map.fitBounds(worldBounds);
    
    $('#players_count').text(guesses.length);
    var point = 0;
    for (var i in guesses) {
      if (google.maps.geometry.spherical.computeDistanceBetween(addisMarker.position, guesses[i]) > meters) {
        point++;
      }
    }
    score = Math.round((point/ guesses.length)*100);
    $('#score').text(score);
    $('#rating').text(rating[Math.floor(score/10)]);
    panel('endgame');
    heatmap.setMap(map);
    map.setMapTypeId(google.maps.MapTypeId.TERRAIN);
  
  });
  
  google.maps.event.addListener(map, 'click', function(event) {
    handleClick(event.latLng);
  });
  
    //tabletop function goes here to convert google spreadsheet into json
    var public_spreadsheet_url = 'https://docs.google.com/spreadsheets/d/1SB1Lw89Li2RT7lr_vS-3dOmeYrOKtXtwt2bNZ2U9nkY/pubhtml';
    Tabletop.init( { key: public_spreadsheet_url,
                     callback: showInfo,
                     simpleSheet: true } )

    function showInfo(dataset, tabletop) {
    console.log("dataset = " + JSON.stringify(dataset));

    for(var i in dataset) {
        guesses.push(new google.maps.LatLng(dataset[i].lat,dataset[i].lng));
      }
    console.log("guesses = " + JSON.stringify(guesses));
    console.log("guesses length = " + guesses.length);

    var pointArray = new google.maps.MVCArray(guesses);

      heatmap = new google.maps.visualization.HeatmapLayer({
        data: pointArray
      });

    }


    
  
  $('#tweet').click(function (event) {
  
    tweet();
  
  });  
  $('#facebook').click(function (event) {
  
    facebook();
  
  });
  
  $(document).keypress(function(event) {
    if ( event.which == 61 ) {
      heatmap.setMap(map);
    }
  });

  
}
google.maps.event.addDomListener(window, 'load', init);



function tweet() {

  var tweet_url = 'https://twitter.com/intent/tweet?related=usvsth3m&text=';
  tweet_url += encodeURIComponent(tweet_rating[Math.ceil(score/10)]);
  tweet_url += encodeURIComponent(' ' + Math.round(miles) + ' miles away, better than ' + score + '% of people. Can you get closer?');
  tweet_url += '&url=http://games.usvsth3m.com/addis/';
  window.open(tweet_url,'_blank');
  
}

function facebook() {

  FB.ui({
  method: 'feed',
  link: 'http://games.usvsth3m.com/addis/',
  picture: 'http://games.usvsth3m.com/addis/intro.jpg',
  name: "Where's addis? Don't Ask Us",
  description: tweet_rating[Math.ceil(score/10)] + ' ' + Math.round(miles) + ' miles away, better than ' + score + '% of people. Can you get closer?'
  }, function(response){});

}

</script>


</head>

<body>

<div id="map-canvas">
</div>

<div id="instructions" class="panel">
  <h1>Where's Addis Ababa? (No googling please)</h1>
  <p>President Obama is going to visit the city that is also known as the political capital of its continent, but do you know where it is?</p>
  <p><button id="start">Bring it on!</button></p>
</div>

<div id="you" class="panel">
<h1>First let's warm up, where do you live?</h1>
<p>Click on the map to mark your home, then click the button to confirm.</p>
<p><button id="home_placed" disabled>I live here</button></p>
</div>

<div id="addis" class="panel">
<h1>Awesome, and now the real challenge, where's Addis Ababa?</h1>
<p>Click on the map where you think Addis Ababa is, then click the button to confirm.</p>
<p><button id="guess_placed" disabled>Addis Ababa is here!</button></p>
</div>

<div id="results" class="panel">
<h1>You were <span id="miles_score">0</span> miles away from the exact location!</h1>
<p>But are you better or worse than other PRI readers?</p>
<p><button id="compare">Compare my results!</button></p>
</div>

<div id="endgame" class="panel">
<h1>This heat map shows answers given by the last <span id="players_count">500</span> users.</h1>
<p>You were better than <span id="score">0</span>% of them. <span id="rating"></span></p>
<button id="tweet">Tweet your score</button>
<button id="facebook">Share on Facebook</button>
</div>

<div id="fb-root"></div>

<script>
  window.fbAsyncInit = function() {
    // init the FB JS SDK
    FB.init({
      appId      : '383984258388383',                        // App ID from the app dashboard
      channelUrl : '//games.usvsth3m.com/channel.html', // Channel file for x-domain comms
      status     : true,                                 // Check Facebook Login status
      xfbml      : true                                  // Look for social plugins on the page
    });

    // Additional initialization code such as adding Event Listeners goes here
  };

  // Load the SDK asynchronously
  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/all.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>
</body>

</html>
